---
title: Next.js 13でブログを作った
description: Markdown絶許
date: 2023-10-16
image: /first.png
published: true
tags: [Tech, Web, Next.js]
---

技術者を自称するインターネット人格にとって個人ブログはマストである。ネットが社会化された現代、個人ブログは唯一の安息の地なのだ。
しかし、そうして過去に作った[旧ブログ](https://trashbox-asa.deno.dev)は記事を1本投稿したきり更新停止しており、早々にエンジニア七不思議の1つ **《恐怖！作ったきり使わないツール&サービス！》** と化してしまった。私用ツールごときに真に大変なのは運用なのだと思い知らされる。

旧ブログではDenoのWebフレームワーク[Fresh](https://fresh.deno.dev)によるEdge SSRを採用していたが、今回はNext.js 13の静的サイト生成を用いた。前回は実装の都合上妥協した部分が後々になって運用のモチベーションにクリティカルに影響したので、今回は妥協しない方針で作っている。

ところで話が変わるが、私はNext.js 13がリリースされるまではWebpackアンチで、ずっとesbuildやViteを使っていた。RSC採用のNext.js 13に《未来》を感じたのでしばらく浮気していたのだが、その間Viteも進化を続けており、最近は静的サイト生成すらViteが流行りになっているらしい。Astro with Viteという選択肢もあったのだが、前回の反省を活かして《安定して汎用的》なNext.jsを選んだ。
代償として、今回はWebpackが原因（推測）でとあるライブラリの採用を諦めた。その他にも「Next.jsがViteだったらなぁ」と思う場面が少なからずあり、やはりViteの体験の良さには遠く及ばないようである。

ところが人間、より醜悪なものをみると今抱えている問題など些事に思えてしまうらしい。今回はそんなモノに出会った。**Markdownって言うんですけど。**

## 実装方針

| 種類     | ライブラリ                 |
| -------- | -------------------------- |
| Web      | Next.js 13 (Static Export) |
| CSS      | Panda CSS                  |
| Markdown | next-mdx-remote            |

CSSフレームワークとして[Panda CSS](https://panda-css.com)というCSS in JSを採用した。コイツはNext.js 13のApp Routerに対応したゼロランタイムCSS in JSという、まさしく次世代のCSSフレームワークである。詳細は後述。

Markdownパーサーには[next-mdx-remote](https://github.com/hashicorp/next-mdx-remote)というhashicorp（Terraform作ってる会社）のライブラリを使っている。記事もサイトのソースコードと一緒のリポジトリで管理するならNext.js公式が提供する`@next/mdx`を使えばいいのだが、プライベート状態で記事を管理したかったのでこちらを選んだ。

デザインの方針だが、サイト全体の配色はモノトーンのライトテーマ一択にした。これは決して配色を考えるのが面倒だったからとかそういう理由ではなく、洞窟に住むインターネット原人たちに陽光を思い出させるという立派な社会貢献のためである。おかげで私は実装中、常に[Dark Reader](https://chrome.google.com/webstore/detail/dark-reader/eimadpbcbfnmbkopoojfekhnkhdbieeh)を使う羽目になった。

## Panda CSS

ざっくり以下のような特徴を持つ。

- ゼロランタイム
- Next.jsのApp Routerのサポート
- その他多くのJSフレームワークのサポート（AstroからQwikまで）
- Cascade Layers, CSS Variable等のモダン機能の採用
- TypeScriptによる型支援
- デザインシステムの構築を容易にする機能

現代のCSSフレームワークへの要求を全てクリアしている。実行時コストを絶対に許さない風潮はどこも同じなようだ。

また、使い方としては直接ライブラリをインポートするのではなく、まずPanda CSSのCLIによって`styled-system`というモジュールを生成し、そこから必要な関数等をインポートするという特殊な方法を取る。この仕組みにより、強力な型支援やデザインシステムの構築を実現しているようだ。

### 使用感

結論から言うと、開発体験はとてもいいが今回のような用途には向いていなかった。

Markdownブログを作る際問題になるのが、Markdownパーサーによって自動生成されたHTMLに対するスタイリングである（私だけかも）。
コンポーネント指向の現代において、多くのCSSフレームワークはこういった《コンポーネント外の要素にスタイルを後付けする》ということが苦手である。ユーティリティ指向のTailwindは言わずもがな、Panda CSSもそういうったことには向かない。一応、`&`セレクタを使ってネイティブCSSのようにスタイルをネストすることは可能なのだが、下流の全ての要素に対して最優先で再帰的にスタイルを適用するというとんでもない代物であり、[公式ドキュメントでも利用は控えるように言われている](https://panda-css.com/docs/concepts/writing-styles#native-css-nesting)。
私が旧ブログで利用していた[Twind CSS](https://twind.style)はネイティブCSS記法のスタイリングができるのだが、残念ながら現在App Router非対応のため採用を見送った

ということで、Markdown部分だけCSS Modules(SCSS)を使うことにした。喜ばしいことにPanda CSSとの競合は一切起こらず、満足の行く結果を得られた。

さて、ならばそれ以外ではPanda CSSを活かせたのかというとそうでもない。静的なただのWebサイトだと、再利用しないパーツが多すぎてPanda CSSの機能を活かしきれない。
私はCSSフレームワークについて大きな思い違いをしていたようである。現代のCSSフレームワークの目的意識は、CSSを簡単にするためというよりも、アプリケーション開発において再利用性・メンテナンス性の高いデザインシステムをいかにスマートに構築するかということにありそうである。エンジニアがボヤきがちなCSSツライ問題のほとんどは、CSSのメンタルモデルが不完全（そもそもCSSは**カスケード言語**なのだ）なことが原因で、より根本的な問題はコンポーネント指向やCSS自体の進化によってとっくに解決されてしまっているのである。

だが、それはそれとしてPanda CSS自体はとてもよかったので、今後はTailwindの代わりにこちらを採用するだろう。

## Markdown

Markdownは、大手サービスから個人開発者に至るまでありとあらゆる者の手によって違法改造が施されており、Markdownブログを作ってみると標準仕様だと思っていたものの多くが実は拡張機能であったことが発覚する。《Markdownパーサー》と銘打つライブラリを1つ落としてきて、適当な`.md`ファイルを食わせてみるといい。なんとテーブルも脚注も段落内改行もできないのである。

しかし安心してほしい。JavaScriptエコシステムにはデファクトスタンダードの処理系[unified](https://unifiedjs.com)が存在する。unifiedは構造化データを扱うエコシステムの総称、及びそのコアパッケージである。unified自体は以下のインターフェースを提供する。

```plaintext title="proceccer"
Input -> Parser -> Syntax Tree -> Compiler -> Output
                        ↑
                   Transformers
```

unifiedでは一連の処理単位をProcessと呼んでおり、各データフォーマットごとにProcessorが実装されている。今回の用途では、[Remark](https://unifiedjs.com/explore/package/remark/)（Markdown）と[Rehype](https://unifiedjs.com/explore/package/rehype/)（Rehype）を利用することになる。また、TransformerによってProcessorの機能を拡張することが可能で、今回はMarkdownの拡張を利用するためにいくつかのRemark/Rehypeプラグインを導入した。

導入したプラグインは以下の通りである。

- Remark
  - remark-breaks
  - remark-gemoji
  - remark-gfm
  - remark-math
- Rehype
  - rehype-katex
  - rehype-pretty-code

......これらを入れてようやく段落内改行、テーブル、脚注、数式、シンタックスハイライト等を利用できるようになる。まあ、これで最低限度の生活は営めそうなのでよしとしよう。じゃ、あとはnext-mdx-remoteよろしく！

**ERROR!**

next-mdx-remoteとプラグインが依存しているunifiedのバージョン不整合である。仕方なくnext-mdx-remoteに合わせていくつかのプラグインのバージョンを下げることになった。人生で初めて依存関係の問題でダウングレードしたので割と動揺した。

### リンクカード

↓これ

http://example.com

Markdownブログの華とも言えるリンクカードだが、正攻法で実装したら非常に面倒だった。実装自体は小さいが、この場合の《面倒》とは「技術者たるものMarkdownブログはマストアイテム！」という軽いノリの風潮に対する相対的な感情である。

旧ブログでは[react-markdown](https://github.com/remarkjs/react-markdown)を利用しており、こちらはカスタムコンポーネントをPropsに渡すことで、生成された要素をJSXでオーバーライドすることができる。旧ブログ実装では`a`要素をオーバーライドし、URLでリンクカードの是非を判定してリンクカードコンポーネントを突っ込んでいた。next-mdx-remoteにも同じくカスタムコンポーネントによるオーバーライドが可能なのだが、今回は全ての`a`要素が`p`要素に内包されていたので上手くいかなかった。

他にいい方法が思いつかなかったので、大人しくunifiedのTransformerを実装することにした。まさかMarkdownブログでパーサーもどきを作ることになるとは思わなかった。Rustの強力な型推論を体験した後のTypeScriptによるパーサー実装はほぼ拷問に近く、一部型の健全性を諦めた。
実装の詳細な説明は割愛するが、URL直貼りのリンクとタイトルが`@card`のリンクを抽出し、`linkcard`という要素に置き換え、next-mdx-remote側で`linkcard`をリンクカードコンポーネントに置換している。

OGP情報は`fetch`してHTMLをパースして抽出している。本当はCloudflareの[html-rewriter-wasm](https://github.com/cloudflare/html-rewriter-wasm)を使うつもりだったが、`utilモジュールがねえ`と言われるので諦めて[node-html-parser](https://github.com/taoqf/node-html-parser)に変えた。最近のHTMLパーサーは通常のDOM APIとほぼ変わらない方法で操作できるので割と感動している。
画像は`og:url`のURLを直接使っているため、いつか何かしらの最適化処理を挟みたい。

## ディレクトリ構造

```
src/
├─app/
├─components/
└─features/
```

正直こんな小規模なサイトだと言うほど構造化するものはないのだが、割としっくりきたので書き記す。

おおよその開発者は、

> 困難は分割せよ

という言葉を信奉しているが、より正しくはこうである。

> 困難は困難になったら分割せよ

私のような人間は困難を幻視して「まず`components`ディレクトリでコンポーネントを定義して…」とかやり始めて一生完成しなくなる。《完成させるのが正義》な個人レベルの制作物だと、ボトムアップ手法は悪手である。

なので、App Routerの構造をそのまま利用しよう。まずApp Routerの`page.tsx`にバーっと書き、読みづらくなってきたらファイルを分割して同階層に`_components`ディレクトリを作って放り込む[^1]。再利用できそうなものが出てきたら`components`に《後から》移す。`features`はMarkdownパーサーとかOGPの取得処理とか、ロジックが長くなりそうなものを突っ込む。

つい「App Routerの責務はルーティングだけにしたい！」と思ってしまうが、それは大規模になったら考える。App RouterはWebサイトの構造を反映しているのだから、そのまま使った方が認知的に自然になる。

[^1]: App Routerにおいて、`_`から始まる名前のディレクトリ・ファイルはルーティングから無視される。

## 総評

大体いい感じになった。楽しい。

まだ追加したい機能や修正箇所もあるのだが、現状最も大きな課題はこのブログサイトをネットの藻屑にしないよう記事を書き続けることである。

> 戦争は平和なり
> 自由は隷従なり
> ~~無知は力なり~~
> 継続は力なり
